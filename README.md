# bingo - Yandex DevOps training 2023 diploma project

Как я развернул руками итоговый проект. 

# Краткое описание проекта

Имеется веб приложение bingo, о котором известно: 
1. Где взять его испоняемый файл
2. Относительные адреса ручек для api
3. Приложение должно быть отказоучтойчивым, держать заданную нагрузку в течение заданного времени и быть развёрнутым до 01.12.23
4. Есть веб-приложение, которое проверяет корректность выполнения проекта

# 1. MVP

Для MVP проекта я выделил следующие его свойства: 
1. Он должен запускаться в облаке
2. Он должен работать на двух нодах и быть способным перезапускаться
3. Должен быть автоматизированный способ проверки, что всё работает и держит хоть какую-то нагрузку.

Порядок подготовки стенда: 
1. Написать dockerfile и docker-compose.yaml для работы приложения
2. Создать проект для terraform. Внутри проекта
    1. Модуль для container registry
    2. Модуль для остальной инфраструктуры (ноды, сеть и БД). В описании ВМ предусмотреть начальный скрипт для инициализации БД.
3. Подготовить Apache JMeter для нагрузочных тестов.

Порядок развёртывания: 
1. Сборка docker образа
2. Развёртывание container registry
3. Положить образ в CR 
4. Развернуть сеть, БД, ноды (именно в таком порядке)  

## 1.1. Он должен запускаться 

Docker и docker compose для запуска выбраны потому что:
* наличие инструментов для перезапуска и проверок работоспособности приложения. 
* наличие интеграции с docker-compose у облачных виртуалок (cloud init).
* такое решение уже было описано в домашних заданиях =)

В `dockerfile` применил multistage чтобы сэкономить размер образа, кроме того: добавил non-root пользователя и запуск приложения происходит не от суперпользователя. 
В `dockerfile` прописан healthcheck. Особенность его состоит в том, что alpine образ не содержит ни curl, ни wget, поэтому wget устанавливается на шаге build в обычную убунту, а затем копируется исполняемый файл в конечный образ. 

 Конфиг bingo монтируется при запуске из docker-compose.  

Точно стоит сказать пару слов про само приложение. Изначально к нему не прилагалось ни конфига, ни инструкции. Чтобы найти данные по настройке необходимо было несколько раз выполнить strace ./bingo с различными ключами - тогда станет видны файлы, которые bingo хочет открыть, адреса, к которым он хочет обратиться. Пример конфига генерировался самим bingo. Изначально, когда было всё совсем непонятно - открыл приложение в IDA PRO и нашёл оттуда адрес для конфига, дальше уже решил по-внимательнее пересмотреть лекции и командой strace нашёл адрес для папки с логами (мой реверс ещё не так хорош и %s в нужной строке сильно выбил из колеи:)). В дальнейшем благодаря реверсу нашёл пасхалки с кодами ctf и по их названию разобрался где их искать.  

## 1.2. Проект для terraform

Prereq: перед выполнением проекта я настроил скачал и настроил terraform по [инструкции Яндекс](https://cloud.yandex.ru/docs/tutorials/infrastructure-management/terraform-quickstart). Кроме того - добавил переменную окружения `YC_SA_ID` с id сервисного аккаунта.  

Чтобы было удобнее разворачивать по шагам, я сделал 2 terraform модуля - для container registry и для всего остального. Настройка двух нод и ноды с БД произодилась через cloud-init и metadata. При выполнении несколько раз пожалел об этом выборе, потому что плейбук на Ansible дал бы больше контроля над происходящим. Тем не менее - выбор именно таких инструментов позволил не усложнять структуру проекта и сдать его в срок. 

После создания container regisrty остаётся output и сгенерированный файл `docker_build`, который соберает образ с нужным тэгом, авторизуется в созданном хранилище и пушит туда нужный образ. 

Далее создавалась нода с БД. В user-data этой ноды содержалась установка и первичная настройка postgresql (которая оказалась 12 версии), создание базы, пользователя, привязка прав пользователя, заполнение базы (скачивание приложения, создания конфига и запуска приложения с кодом *prepare_db*), создание индексов на поля id таблиц. 

При настройке нод требовалось создать папки для логов и конфига, создать файл с конфигом (для этого нужны были данные с предыдущего шага) и настроть iptables для получения ctf-кода и быстрого запуска приложения. На 02.12.23 там остался кусочек дебажного кода про создание файла docker-compose. Кроме того - т.к. вносить изменения в репозиторий после дедлайна было нельзя, то оставлю здесь в описании используемый конфг nginx, который позволил использовать https и сохранить обращение по http 
```
worker_processes  2;
user www-data;
events {
    use           epoll;
    worker_connections  128;
}
http {
    server_tokens off;
    include       mime.types;
    charset       utf-8;    
    server {
        listen 80;
        server_name direbo.ru;
        location / {
            proxy_pass http://localhost:8080;
        }
    }
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name direbo.ru;
        ssl_certificate          /etc/ssl/direbo/direbo.crt;
        ssl_certificate_key      /etc/ssl/direbo/direbo.key;
        location / {
            proxy_set_header   X-Forwarded-For $remote_addr;
            proxy_set_header   Host $http_host;   
            proxy_pass         http://localhost:8080;
        }
    }
}
```
# Итого:
Чтобы развернуть проект:
- создать ключи ssh с именем key и положить их в папке terraform/modules/vps/.ssh
- настроить terraform 
- создать переменную окружения YC_SA_ID и добавить туда id сервисного аккаунта.  

Что бы я хотел улучшить и исправить в проекте: 
1. в скриптах terraform под container registry, нод с приложением, ноды с БД использовать сервисные аккаунты с ограниченным доступом. Соответственно - не передавать id сервисного аккаунта в качестве переменной.
2. при настройке БД: 
* использовать как минимум шифрованный пароль для авторизации
* в listen address прописать только адреса нод и ip компа для администрирования (впрочем можно его не добавлять без неоходимости)
* создать реплики на нодах с приложением для ускорения чтения.
3. прописать группу безопасности в которой закрыть все входящие подключения к нодам и открывать ssh только по необходимости. К нодам должен обращаться только балансировщик.
4. файл с https сертификатом положить на s3, к которому тоже ограничить доступ. Для этого также потребуется изменить текст user-data для нод с приложением. 
5. не оставлять значения по умолчанию для credentials к БД в переменных модуля terraform. 
6. настроить кэширование запросов на nginx на нодах. 
7. настроить сбор и обработку метрик. 
8. использовать меньше списков при создании описания.

Спасибо большое Яндекс и отдельно команде DevOps Training за такую интересную и захватывающую задачу!